<!DOCTYPE html>
<html lang=Ch>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta name="keywords" content="MIT6.828,OS">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.828:assignment7:LAB3用户环境">
<meta property="og:url" content="http://yoursite.com/2019/06/28/mit6-828A7/index.html">
<meta property="og:site_name" content="JiHandong&#39;s Blog">
<meta property="og:description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta property="og:locale" content="Chinese">
<meta property="og:image" content="http://yoursite.com/2019/06/28/mit6-828A7/envid_t.png">
<meta property="og:image" content="http://yoursite.com/2019/06/28/mit6-828A7/VirtualBox_saya_30_06_2019_02_45_17.png">
<meta property="og:updated_time" content="2019-07-01T05:17:56.368Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.828:assignment7:LAB3用户环境">
<meta name="twitter:description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta name="twitter:image" content="http://yoursite.com/2019/06/28/mit6-828A7/envid_t.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MIT6.828:assignment7:LAB3用户环境</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2019/06/13/vim常用操作/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/28/mit6-828A7/&text=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/28/mit6-828A7/&is_video=false&description=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MIT6.828:assignment7:LAB3用户环境&body=Check out this article: http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/28/mit6-828A7/&name=MIT6.828:assignment7:LAB3用户环境&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-A：用户环境和异常处理"><span class="toc-number">2.</span> <span class="toc-text">Part A：用户环境和异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Environment-State"><span class="toc-number">2.1.</span> <span class="toc-text">Environment State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Allocating-the-Environments-Array"><span class="toc-number">2.2.</span> <span class="toc-text">Allocating the Environments Array</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Exercise1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-and-Running-Environments"><span class="toc-number">2.3.</span> <span class="toc-text">Creating and Running Environments</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise2"><span class="toc-number">2.3.1.</span> <span class="toc-text">Exercise2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中断-异常-Control-Transfer保护机制"><span class="toc-number">2.4.</span> <span class="toc-text">中断 异常 Control Transfer保护机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#An-Example"><span class="toc-number">2.5.</span> <span class="toc-text">An Example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nested-Exceptions-and-Interrupts"><span class="toc-number">2.6.</span> <span class="toc-text">Nested Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-Up-the-IDT"><span class="toc-number">2.7.</span> <span class="toc-text">Setting Up the IDT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise4"><span class="toc-number">2.7.1.</span> <span class="toc-text">Exercise4</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge"><span class="toc-number">2.8.</span> <span class="toc-text">challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Questions"><span class="toc-number">2.9.</span> <span class="toc-text">Questions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-B：Page-Fault（缺页），断点异常，系统调用"><span class="toc-number">3.</span> <span class="toc-text">Part B：Page Fault（缺页），断点异常，系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-Faults"><span class="toc-number">3.1.</span> <span class="toc-text">Page Faults</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise5"><span class="toc-number">3.1.1.</span> <span class="toc-text">Exercise5</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Breakpoint-Exception"><span class="toc-number">3.2.</span> <span class="toc-text">Breakpoint Exception</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise6"><span class="toc-number">3.2.1.</span> <span class="toc-text">Exercise6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge"><span class="toc-number">3.2.2.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Questtions"><span class="toc-number">3.2.3.</span> <span class="toc-text">Questtions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#System-Calls"><span class="toc-number">3.3.</span> <span class="toc-text">System Calls</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise7"><span class="toc-number">3.3.1.</span> <span class="toc-text">Exercise7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">Challenge</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-mode-startup"><span class="toc-number">3.4.</span> <span class="toc-text">User-mode startup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise8"><span class="toc-number">3.4.1.</span> <span class="toc-text">Exercise8</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-Faults-and-Memory-Protection"><span class="toc-number">3.5.</span> <span class="toc-text">Page Faults and Memory Protection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise9"><span class="toc-number">3.5.1.</span> <span class="toc-text">Exercise9</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise10"><span class="toc-number">3.5.2.</span> <span class="toc-text">Exercise10</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-A"><span class="toc-number">5.1.</span> <span class="toc-text">Part A</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MIT6.828:assignment7:LAB3用户环境
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">JiHandong's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-06-27T21:00:40.000Z" itemprop="datePublished">2019-06-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/MIT6-828/">MIT6.828</a>, <a class="tag-link" href="/tags/OS/">OS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>  在Lab2中,<code>mem_init()</code>函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。<br>  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用术语“环境”只是为了和UNIX的“进程”区分。<br>  创建lab3分支，从lab2中merge过来，本次实验分AB两个部分，schedule上每个部分给予一周时间，同样需要完成所有的练习和至少一个challenge。可以使用<strong>内联汇编</strong>的语法。</p>
<h2 id="Part-A：用户环境和异常处理"><a href="#Part-A：用户环境和异常处理" class="headerlink" title="Part A：用户环境和异常处理"></a>Part A：用户环境和异常处理</h2><p>  阅读<code>inc/env.h</code>文件。<br>  其中数据结构envid_t可以表示一个环境，如图所示，后10位储存在<code>Env</code>中的index，即自己的座位号；而中间的21位是每个环境独一无二的ID；由于envid_t本质上是int，首位为0表示一个正数，如果为1表示为一个负数，对于envid_t负数被解读为错误。<br><img src="/2019/06/28/mit6-828A7/envid_t.png"></p>
<h3 id="Environment-State"><a href="#Environment-State" class="headerlink" title="Environment State"></a>Environment State</h3><p>  阅读<code>inc/env.h</code>文件中定义的<code>struct Env</code>。每个成员都包含了一个环境的关键属性，比如page directory的地址、此环境的id（envid_t类型变量）、父环境</p>
<p>的id（envid_t类型变量）。</p>
<h3 id="Allocating-the-Environments-Array"><a href="#Allocating-the-Environments-Array" class="headerlink" title="Allocating the Environments Array"></a>Allocating the Environments Array</h3><p>  Lab2中我们部署了pages线性表，这次来部署一下envs线性表。</p>
<h4 id="Exercise1"><a href="#Exercise1" class="headerlink" title="Exercise1"></a>Exercise1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Modify mem_init() in kern/pmap.c to allocate and map the envs array.</span><br><span class="line">This array consists of exactly NENV instances of the Env structure allocated much like how you allocated the pages array.</span><br><span class="line">Also like the pages array, the memory backing envs should also be mapped user read-only at UENVS (defined in inc/memlayout.h) so user processes can read from this array.</span><br><span class="line">You should run your code and make sure check_kern_pgdir() succeeds.</span><br></pre></td></tr></table></figure>
<p>  <code>kern/pmap.c</code>中新include了<code>kern/env.h</code>，由<code>inc/env.h</code>的定义，我们知道10位用于在envs中的寻址，所以envs的长度为2^10；<code>envs</code>定义在<code>kern/env.c</code>中。<br>  这部分代码和Lab2中的对pages的分配大同小异，先使用<code>boot_alloc()</code>为envs准备空白的物理地址；随后建立二级页表对UENVS开始的一个PTSIZE进行map。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	envs = (struct Env*) boot_alloc(NENV * <span class="keyword">sizeof</span>(struct Env));</span><br><span class="line">	<span class="built_in">memset</span>(pages, <span class="number">0</span>, NENV * <span class="keyword">sizeof</span>(struct Env));</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="comment">// Map the 'envs' array read-only by the user at linear address UENVS</span></span><br><span class="line">	<span class="comment">// (ie. perm = PTE_U | PTE_P).</span></span><br><span class="line">	<span class="comment">// Permissions:</span></span><br><span class="line">	<span class="comment">//    - the new image at UENVS  -- kernel R, user R</span></span><br><span class="line">	<span class="comment">//    - envs itself -- kernel RW, user NONE</span></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	ptp = page_alloc(<span class="number">1</span>);</span><br><span class="line">	pt = KADDR(PTE_ADDR(page2pa(ptp)));</span><br><span class="line">	kern_pgdir[PDX(UENVS)]= page2pa(ptp) | PTE_U | PTE_P;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> bias = <span class="number">0</span>; bias &lt; NENV*<span class="keyword">sizeof</span>(struct Env); bias += PGSIZE) &#123;</span><br><span class="line">		pt[PTX(UENVS+bias)] = PADDR((<span class="keyword">void</span>*)envs+bias) | PTE_U | PTE_P;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Creating-and-Running-Environments"><a href="#Creating-and-Running-Environments" class="headerlink" title="Creating and Running Environments"></a>Creating and Running Environments</h3><p>  现在我们开始对<code>kern/env.c</code>编程，即我们开始编写运行用户环境的代码。<br>  <code>obj/Makefrag</code>中有一些能够将二进制文件像.o文件那样”link”起来的骚操作；obj/kern/kernel.sym中也能看到一些神奇的符号。<br>  <code>kern/init.c</code>中的<code>i386_init()</code>能够运行上面谈到的二进制image，然而我们还需要在Exercise2中编写设置用户环境的函数。</p>
<h4 id="Exercise2"><a href="#Exercise2" class="headerlink" title="Exercise2"></a>Exercise2</h4><p><strong>In the file env.c, finish coding the following functions:env_init()、env_setup_vm()、region_alloc()、load_icode()、env_create()、env_run()</strong><br>  首先了解一下各个函数的功能：<br>  <code>env_init()</code>初始化envs线性表中的全部Env结构，并全部加入env_free_list；<code>env_init_percpu()</code>能够为不同特权级别的段单独配置segmentation hardware；<br>  <code>env_setup_vm()</code>为新的环境分配page directory，并初始化其中的内核空间（不用用户环境的内核代码都映射且仅映射到同一个地方）；<br>  <code>region_alloc()</code>为新环境allocate长度为len的物理内存并map到环境的地址空间va位置，不需要初始化其中的内容；<br>  <code>load_icode()</code>解析ELF二进制image，加载到用户地址；<br>  <code>env_create()</code>创建新环境需要调用<code>env_alloc()</code>分配空间，调用<code>load_icode()</code>加载；<br>  <code>env_run()</code>以用户模式运行一个给出的环境；<br>  然后我们可以编写代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">env_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span>(struct Env* e = envs+NENV<span class="number">-1</span>; e &gt;= envs; e--) &#123;</span><br><span class="line">		e-&gt;env_id = <span class="number">0</span>;</span><br><span class="line">		e-&gt;env_link = env_free_list;</span><br><span class="line">		env_free_list = e;	</span><br><span class="line">	&#125;</span><br><span class="line">	env_init_percpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化用户环境</span></span><br><span class="line"><span class="comment">// 需要复制kern_pgdir中内核部分的内容</span></span><br><span class="line"><span class="comment">// 其实直接全部复制就可以了，kern_pgdir的内容全是内存映射</span></span><br><span class="line"><span class="comment">// 只有UVPT需要单独设置</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">env_setup_vm(struct Env *e)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line">	p-&gt;pp_ref++;	</span><br><span class="line">	e-&gt;env_pgdir = (<span class="keyword">pde_t</span>*)KADDR(page2pa(p));</span><br><span class="line">	<span class="built_in">memcpy</span>(e-&gt;env_pgdir, kern_pgdir, PGSIZE);</span><br><span class="line">	e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为环境e分配len字节到虚拟地址va</span></span><br><span class="line"><span class="comment">// 使用page_insert更方便</span></span><br><span class="line"><span class="comment">// 有必要熟悉自己在前面实验中完成的函数工具，抽象分层已经做了，不用是自己吃亏</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">region_alloc(struct Env *e, <span class="keyword">void</span> *va, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span>* begin = ROUNDDOWN(va, PGSIZE);</span><br><span class="line">	<span class="keyword">void</span>* end = ROUNDUP(va+len, PGSIZE);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">for</span>(; begin &lt; end; begin += PGSIZE) &#123;</span><br><span class="line">		<span class="keyword">if</span>(!(p = page_alloc(<span class="number">0</span>))) panic(<span class="string">"alloc page failed in region_alloc()\n"</span>);</span><br><span class="line">		page_insert(e-&gt;env_pgdir, p, begin, PTE_W | PTE_U);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载ELF可执行文件到环境e</span></span><br><span class="line"><span class="comment">// 需要注意几个要点</span></span><br><span class="line"><span class="comment">// 1、页表：需要使用lcr3()切换到环境e的页表，这样mem系列函数才能正常工作</span></span><br><span class="line"><span class="comment">// 2、起始地址：需要设置起始地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">load_icode(struct Env *e, <span class="keyword">uint8_t</span> *binary)</span><br><span class="line">&#123;</span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> *<span class="title">elfhdr</span> = (<span class="title">struct</span> <span class="title">Elf</span>*)<span class="title">binary</span>;</span></span><br><span class="line">	ph = (struct Proghdr *) (binary + elfhdr-&gt;e_phoff);</span><br><span class="line">	eph = ph + elfhdr-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span> (; ph &lt; eph; ph++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(ph-&gt;p_type == ELF_PROG_LOAD) &#123;</span><br><span class="line">			region_alloc(e, (<span class="keyword">void</span>*)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memset</span>((<span class="keyword">void</span>*)ph-&gt;p_va, <span class="number">0</span>, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memcpy</span>((<span class="keyword">void</span>*)ph-&gt;p_va, binary+ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	lcr3(PADDR(kern_pgdir));</span><br><span class="line">	e-&gt;env_tf.tf_eip = elfhdr-&gt;e_entry;</span><br><span class="line"></span><br><span class="line">	region_alloc(e, (<span class="keyword">void</span>*)USTACKTOP - PGSIZE, PGSIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">env_create(<span class="keyword">uint8_t</span> *binary, <span class="keyword">enum</span> EnvType type)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span>* <span class="title">e</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	env_alloc(&amp;e, <span class="number">0</span>);</span><br><span class="line">	load_icode(e, binary);</span><br><span class="line">	e-&gt;env_type = type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">env_run(struct Env *e)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(curenv &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)</span><br><span class="line">		curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line">	curenv = e;</span><br><span class="line">	e-&gt;env_status = ENV_RUNNING;</span><br><span class="line">	e-&gt;env_runs++;</span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">	env_pop_tf(&amp;(e-&gt;env_tf));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  完成之后如果直接执行make qemu会因为进入用户模式而出现三重错误，正确的检查方式是在gdb模式下，将断点打在<code>boot/main.c</code>中<code>sys_cputs()</code>的int系统调用指令上，如果能顺利运行到该处，说明完成。<br><img src="/2019/06/28/mit6-828A7/VirtualBox_saya_30_06_2019_02_45_17.png"></p>
<h3 id="中断-异常-Control-Transfer保护机制"><a href="#中断-异常-Control-Transfer保护机制" class="headerlink" title="中断 异常 Control Transfer保护机制"></a>中断 异常 Control Transfer保护机制</h3><p>  在Exercise2中，程序在用户模式下走到了死胡同。我们需要建立基本的异常和系统调用处理机制，以实现内核从用户模式恢复控制权。<br>  在不同的架构和OS之间，exception、trap、 interrupt、 fault、abort都没有统一的精确定义，6.828大体参考Intel’s terminology。<br>  如果还没做好准备，阅读<a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/c09.htm" target="_blank" rel="noopener">Chapter 9, Exceptions and Interrupts</a></p>
<p>  中断和异常都会导致用户模式切换到内核模式。</p>
<ul>
<li>中断：受保护的控制转移，一般由外部I/O活动导致；</li>
<li>异常：同样是受保护的控制转移，一般由内部代码导致，比如除0；</li>
</ul>
<p>  保护由两个机制提供：</p>
<ul>
<li>IDT(Interrupt Descriptor Table)：中断描述表/中断矢量表，是一个handler程序的“目录”，保存有不同类型中断的处理程序入口地址（eip，cs）；</li>
<li>TSS(Task State Segment)：在终端/异常结束之前保存旧的处理器状态（一些重要寄存器的状态，比如eip，cs等）；</li>
</ul>
<p>  处理器<strong>内部异步异常</strong>的矢量为0~31，&gt;31的留作<strong>软件中断</strong>，使用int指令或由异步硬件外设生成。</p>
<h3 id="An-Example"><a href="#An-Example" class="headerlink" title="An Example"></a>An Example</h3><p>  将上面有关中断和异常有关的知识点结合起来，讨论一个实例。<br>  假设我们在用户环境中执行代码，碰到了一个除0错误：</p>
<ol>
<li>处理器切换到TSS中SS0和ESP0指定的栈，JOS保持GD_KD和KSTACKTOP；</li>
<li><p>处理器将异常参数推入KSTACKTOP开始的内核栈；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+ KSTACKTOP             </span><br><span class="line">| 0x00000 | old SS   |     &quot; - 4</span><br><span class="line">|      old ESP       |     &quot; - 8</span><br><span class="line">|     old EFLAGS     |     &quot; - 12</span><br><span class="line">| 0x00000 | old CS   |     &quot; - 16</span><br><span class="line">|      old EIP       |     &quot; - 20 &lt;---- ESP </span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>除0对应的中断矢量是0，访问IDT得到CS:EIP；</p>
</li>
<li><p>相应的handler得到控制权；</p>
<p>对于某些特定的异常可能还会推入一个error code，栈的结构如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+ KSTACKTOP             </span><br><span class="line">| 0x00000 | old SS   |     &quot; - 4</span><br><span class="line">|      old ESP       |     &quot; - 8</span><br><span class="line">|     old EFLAGS     |     &quot; - 12</span><br><span class="line">| 0x00000 | old CS   |     &quot; - 16</span><br><span class="line">|      old EIP       |     &quot; - 20</span><br><span class="line">|     error code     |     &quot; - 24 &lt;---- ESP</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Nested-Exceptions-and-Interrupts"><a href="#Nested-Exceptions-and-Interrupts" class="headerlink" title="Nested Exceptions and Interrupts"></a>Nested Exceptions and Interrupts</h3><p>  处理器在用户态和内核态都能接受异常，在后者情况下可以不切换栈；就不需要保存栈的环境，需要压栈的内容少了很多。这种异常被称作nested exception（嵌套异常）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+ &lt;---- old ESP</span><br><span class="line">|     old EFLAGS     |     &quot; - 4</span><br><span class="line">| 0x00000 | old CS   |     &quot; - 8</span><br><span class="line">|      old EIP       |     &quot; - 12</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure></p>
<h3 id="Setting-Up-the-IDT"><a href="#Setting-Up-the-IDT" class="headerlink" title="Setting Up the IDT"></a>Setting Up the IDT</h3><p>  经过上面的知识预备，我们可以开始设置IDT处理0-31的异常。<br>  <code>inc/trap.h</code>和<code>kern/trap.h</code>中包含对设计有用的重要声明。<br>  PS：0-31中有的标号本来就是Intel保留的，其永远不会被处理器生成。<br>  目标结构应该如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">      IDT                   trapentry.S         trap.c</span><br><span class="line">   </span><br><span class="line">+----------------+                        </span><br><span class="line">|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)</span><br><span class="line">|                |             // do stuff      &#123;</span><br><span class="line">|                |             call trap          // handle the exception/interrupt</span><br><span class="line">|                |             // ...           &#125;</span><br><span class="line">+----------------+</span><br><span class="line">|   &amp;handler2    |--------&gt; handler2:</span><br><span class="line">|                |            // do stuff</span><br><span class="line">|                |            call trap</span><br><span class="line">|                |            // ...</span><br><span class="line">+----------------+</span><br><span class="line">       .</span><br><span class="line">       .</span><br><span class="line">       .</span><br><span class="line">+----------------+</span><br><span class="line">|   &amp;handlerX    |--------&gt; handlerX:</span><br><span class="line">|                |             // do stuff</span><br><span class="line">|                |             call trap</span><br><span class="line">|                |             // ...</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure></p>
<p>  每个异常/中断都应该在<code>trapentry.S</code>中有自己的handler，且<code>trap_init()</code>应能够用这些handlers初始化IDT。每个handler都应该在栈中创建一个struct Trapframe，并使用指向这个Trapframe的指针来调用<code>trap()</code>处理异常/中断。</p>
<h4 id="Exercise4"><a href="#Exercise4" class="headerlink" title="Exercise4"></a>Exercise4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Edit trapentry.S and trap.c and implement the features described above.下面是一些提示： </span><br><span class="line">	The macros TRAPHANDLER and TRAPHANDLER_NOEC in trapentry.S should help you, as well as the T_* defines in inc/trap.h.（提供的一些宏工具）</span><br><span class="line">	You will need to add an entry point in trapentry.S (using those macros) for each trap defined in inc/trap.h.（为每个trap添加entry point）</span><br><span class="line">	and you&apos;ll have to provide _alltraps which the TRAPHANDLER macros refer to.（?）</span><br><span class="line">	You will also need to modify trap_init() to initialize the idt to point to each of these entry points defined in trapentry.S; the SETGATE macro will be helpful here. （使用mmu.h中的SETGATE初始化IDT）</span><br><span class="line"></span><br><span class="line">_alltraps应该满足：</span><br><span class="line">	push values to make the stack look like a struct Trapframe</span><br><span class="line">	load GD_KD into %ds and %es</span><br><span class="line">	pushl %esp to pass a pointer to the Trapframe as an argument to trap()</span><br><span class="line">	call trap (can trap ever return?)</span><br><span class="line"></span><br><span class="line">考虑使用pushal指令，它完美地符合栈的布局。</span><br><span class="line"></span><br><span class="line">使用make grade测试，提供了几个会触发异常的函数。</span><br></pre></td></tr></table></figure>
<p>  认真阅读题目：</p>
<ol>
<li><code>kern/trapentry.S</code>中我们需要设置各handler的entry point具体可以用提供的两个宏来设置，两个分别用于有无error code的trap handler。之后所有的程序都要转到<code>_trapsall</code>标号处，完整地传入一个struct Trapframe作为参数（这里与xv6参考手册的设置不符合，不需要传入%fs和%gs作为参数，如果传入会导致trap类型的判断错误，应该以struct Trapframe为准）。</li>
<li><p><code>kern/trap.c</code>的<code>trap_init()</code>中我们需要设置IDT，使用的SETGATE宏可以通过<code>grep -rl</code>找到，根据其描述合理地设置传入参数，分条设置IDT；这里需要传入handler的entry point作为参数，通过在外面把标号作为函数名，进行一堆<strong>弱定义</strong>即可。<br> 最终<code>kern/trapentry.S</code>的新增内容如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">TRAPHANDLER_NOEC(hdr0, T_DIVIDE) ;根据是否传入error code选择宏</span><br><span class="line">TRAPHANDLER_NOEC(hdr1, T_DEBUG)</span><br><span class="line">TRAPHANDLER_NOEC(hdr2, T_NMI)</span><br><span class="line">TRAPHANDLER_NOEC(hdr3, T_BRKPT)</span><br><span class="line">TRAPHANDLER_NOEC(hdr4, T_OFLOW)</span><br><span class="line">TRAPHANDLER_NOEC(hdr5, T_BOUND)</span><br><span class="line">TRAPHANDLER_NOEC(hdr6, T_ILLOP)</span><br><span class="line">TRAPHANDLER_NOEC(hdr7, T_DEVICE)</span><br><span class="line">TRAPHANDLER(hdr8, T_DBLFLT)</span><br><span class="line"></span><br><span class="line">TRAPHANDLER(hdr10, T_TSS)</span><br><span class="line">TRAPHANDLER(hdr11, T_SEGNP)</span><br><span class="line">TRAPHANDLER(hdr12, T_STACK)</span><br><span class="line">TRAPHANDLER(hdr13, T_GPFLT)</span><br><span class="line">TRAPHANDLER(hdr14, T_PGFLT)</span><br><span class="line"></span><br><span class="line">TRAPHANDLER_NOEC(hdr16, T_FPERR)</span><br><span class="line">TRAPHANDLER(hdr17, T_ALIGN)</span><br><span class="line">TRAPHANDLER_NOEC(hdr18, T_MCHK)</span><br><span class="line">TRAPHANDLER_NOEC(hdr19, T_SIMDERR)</span><br><span class="line"></span><br><span class="line">_alltraps:</span><br><span class="line">	pushl %ds</span><br><span class="line">	pushl %es</span><br><span class="line">	pushal				;不需要传入%fs,%gs</span><br><span class="line">	movw $GD_KD, %ax	;这里注意是16位寄存器</span><br><span class="line">	movw %ax, %ds</span><br><span class="line">	movw %ax, %es</span><br><span class="line">	pushl %esp</span><br><span class="line">	call trap</span><br></pre></td></tr></table></figure>
<p>而<code>kern/trap.c</code>为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr0</span><span class="params">()</span></span>;	<span class="comment">//弱符号会被链接到trapentry.S的强定义上</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr1</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr2</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr3</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr4</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr5</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr6</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr7</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr8</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr10</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr11</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr12</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr13</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr14</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr16</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr17</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr18</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hdr19</span><span class="params">()</span></span>; </span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">trap_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">Segdesc</span> <span class="title">gdt</span>[];</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Yur code here.</span></span><br><span class="line">	SETGATE(idt[T_DIVIDE],  <span class="number">1</span>, GD_KT, hdr0, <span class="number">0</span>); <span class="comment">//GD_KT指.text即是CS段</span></span><br><span class="line">	SETGATE(idt[T_DEBUG],   <span class="number">1</span>, GD_KT, hdr1, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_NMI],     <span class="number">1</span>, GD_KT, hdr2, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_BRKPT],   <span class="number">1</span>, GD_KT, hdr3, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_OFLOW],   <span class="number">1</span>, GD_KT, hdr4, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_BOUND],   <span class="number">1</span>, GD_KT, hdr5, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_ILLOP],   <span class="number">1</span>, GD_KT, hdr6, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_DEVICE],  <span class="number">1</span>, GD_KT, hdr7, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_DBLFLT],  <span class="number">1</span>, GD_KT, hdr8, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//9</span></span><br><span class="line">	SETGATE(idt[T_TSS],     <span class="number">1</span>, GD_KT, hdr10, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_SEGNP],   <span class="number">1</span>, GD_KT, hdr11, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_STACK],   <span class="number">1</span>, GD_KT, hdr12, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_GPFLT],   <span class="number">1</span>, GD_KT, hdr13, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_PGFLT],   <span class="number">1</span>, GD_KT, hdr14, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//15</span></span><br><span class="line">	SETGATE(idt[T_FPERR],   <span class="number">1</span>, GD_KT, hdr16, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_ALIGN],   <span class="number">1</span>, GD_KT, hdr17, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_MCHK],    <span class="number">1</span>, GD_KT, hdr18, <span class="number">0</span>);</span><br><span class="line">	SETGATE(idt[T_SIMDERR], <span class="number">1</span>, GD_KT, hdr19, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Per-CPU setup </span></span><br><span class="line">	trap_init_percpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到目前为止make grade应该能得到Part A的满分。</p>
</li>
</ol>
<h3 id="challenge"><a href="#challenge" class="headerlink" title="challenge"></a>challenge</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">完成Exercise4得到了一堆冗长的代码，between the lists of TRAPHANDLER in trapentry.S and their installations in trap.c</span><br><span class="line">为了更加优雅，可以修改trapentry.S的宏来自动生成trap.c的table。</span><br><span class="line">Note that you can switch between laying down code and data in the assembler by using the directives .text and .data.</span><br></pre></td></tr></table></figure>
<h3 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">为什么要为每个exception/interrupt设置单独的handler函数?</span><br><span class="line">如果所有exceptions/interrupts都被传送到同一个handler，我们应该提供什么特性？</span><br><span class="line"></span><br><span class="line">为了使得user/softint正常工作需要做什么？</span><br><span class="line">grade script期待其产生一个general protection fault(trap 13)，但是softint的代码说了int $14；为什么这会产生trap 13。</span><br><span class="line">如果内核真的允许int $14去invoke内核的page fault handler(trap 14)会怎么样？</span><br></pre></td></tr></table></figure>
<h2 id="Part-B：Page-Fault（缺页），断点异常，系统调用"><a href="#Part-B：Page-Fault（缺页），断点异常，系统调用" class="headerlink" title="Part B：Page Fault（缺页），断点异常，系统调用"></a>Part B：Page Fault（缺页），断点异常，系统调用</h2><h3 id="Page-Faults"><a href="#Page-Faults" class="headerlink" title="Page Faults"></a>Page Faults</h3><h4 id="Exercise5"><a href="#Exercise5" class="headerlink" title="Exercise5"></a>Exercise5</h4><h3 id="Breakpoint-Exception"><a href="#Breakpoint-Exception" class="headerlink" title="Breakpoint Exception"></a>Breakpoint Exception</h3><h4 id="Exercise6"><a href="#Exercise6" class="headerlink" title="Exercise6"></a>Exercise6</h4><h4 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h4><h4 id="Questtions"><a href="#Questtions" class="headerlink" title="Questtions"></a>Questtions</h4><h3 id="System-Calls"><a href="#System-Calls" class="headerlink" title="System Calls"></a>System Calls</h3><h4 id="Exercise7"><a href="#Exercise7" class="headerlink" title="Exercise7"></a>Exercise7</h4><h4 id="Challenge-1"><a href="#Challenge-1" class="headerlink" title="Challenge"></a>Challenge</h4><h3 id="User-mode-startup"><a href="#User-mode-startup" class="headerlink" title="User-mode startup"></a>User-mode startup</h3><h4 id="Exercise8"><a href="#Exercise8" class="headerlink" title="Exercise8"></a>Exercise8</h4><h3 id="Page-Faults-and-Memory-Protection"><a href="#Page-Faults-and-Memory-Protection" class="headerlink" title="Page Faults and Memory Protection"></a>Page Faults and Memory Protection</h3><h4 id="Exercise9"><a href="#Exercise9" class="headerlink" title="Exercise9"></a>Exercise9</h4><h4 id="Exercise10"><a href="#Exercise10" class="headerlink" title="Exercise10"></a>Exercise10</h4><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab3/" target="_blank" rel="noopener">2018,mit6.828,Lab3</a><br><a href="https://www.jianshu.com/p/f67034d0c3f2" target="_blank" rel="noopener">博客文章1</a></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><h3 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h3><ol>
<li>对于卡壳：如果卡壳太久了还是看别人博客比较好：最后的一点小bug往往很久才能查出，即使自己发现也难以得到很大收获，性价比太低。以后做Exercise应该在心中有一个时间安排，超时100%时应该及时放弃。</li>
<li>审题：认真阅读题目需求和提示，磨刀不误砍柴功；写下操作计划再开始编程和测试。</li>
<li>准备：明明是学校汇（BAO）编（GAO）课上就应该熟练的东西，现在还是不太熟练。</li>
<li>意外收获：做实验之外还发现了virtualbox可以多监视器（显示器），但是没有安装图形界面似乎不能直接支持这个功能？对vim的virsul模式和<code>.</code>重复指令更加熟练了，新了解了大小写转换的一些指令。</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-A：用户环境和异常处理"><span class="toc-number">2.</span> <span class="toc-text">Part A：用户环境和异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Environment-State"><span class="toc-number">2.1.</span> <span class="toc-text">Environment State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Allocating-the-Environments-Array"><span class="toc-number">2.2.</span> <span class="toc-text">Allocating the Environments Array</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Exercise1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-and-Running-Environments"><span class="toc-number">2.3.</span> <span class="toc-text">Creating and Running Environments</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise2"><span class="toc-number">2.3.1.</span> <span class="toc-text">Exercise2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中断-异常-Control-Transfer保护机制"><span class="toc-number">2.4.</span> <span class="toc-text">中断 异常 Control Transfer保护机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#An-Example"><span class="toc-number">2.5.</span> <span class="toc-text">An Example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nested-Exceptions-and-Interrupts"><span class="toc-number">2.6.</span> <span class="toc-text">Nested Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-Up-the-IDT"><span class="toc-number">2.7.</span> <span class="toc-text">Setting Up the IDT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise4"><span class="toc-number">2.7.1.</span> <span class="toc-text">Exercise4</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge"><span class="toc-number">2.8.</span> <span class="toc-text">challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Questions"><span class="toc-number">2.9.</span> <span class="toc-text">Questions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-B：Page-Fault（缺页），断点异常，系统调用"><span class="toc-number">3.</span> <span class="toc-text">Part B：Page Fault（缺页），断点异常，系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-Faults"><span class="toc-number">3.1.</span> <span class="toc-text">Page Faults</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise5"><span class="toc-number">3.1.1.</span> <span class="toc-text">Exercise5</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Breakpoint-Exception"><span class="toc-number">3.2.</span> <span class="toc-text">Breakpoint Exception</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise6"><span class="toc-number">3.2.1.</span> <span class="toc-text">Exercise6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge"><span class="toc-number">3.2.2.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Questtions"><span class="toc-number">3.2.3.</span> <span class="toc-text">Questtions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#System-Calls"><span class="toc-number">3.3.</span> <span class="toc-text">System Calls</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise7"><span class="toc-number">3.3.1.</span> <span class="toc-text">Exercise7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Challenge-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">Challenge</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-mode-startup"><span class="toc-number">3.4.</span> <span class="toc-text">User-mode startup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise8"><span class="toc-number">3.4.1.</span> <span class="toc-text">Exercise8</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-Faults-and-Memory-Protection"><span class="toc-number">3.5.</span> <span class="toc-text">Page Faults and Memory Protection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise9"><span class="toc-number">3.5.1.</span> <span class="toc-text">Exercise9</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercise10"><span class="toc-number">3.5.2.</span> <span class="toc-text">Exercise10</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-A"><span class="toc-number">5.1.</span> <span class="toc-text">Part A</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/28/mit6-828A7/&text=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/28/mit6-828A7/&is_video=false&description=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MIT6.828:assignment7:LAB3用户环境&body=Check out this article: http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/28/mit6-828A7/&name=MIT6.828:assignment7:LAB3用户环境&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 jihandong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
