<!DOCTYPE html>
<html lang=Ch>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta name="keywords" content="MIT6.828,OS">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.828:assignment7:LAB3用户环境">
<meta property="og:url" content="http://yoursite.com/2019/06/28/mit6-828A7/index.html">
<meta property="og:site_name" content="JiHandong&#39;s Blog">
<meta property="og:description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta property="og:locale" content="Chinese">
<meta property="og:image" content="http://yoursite.com/2019/06/28/mit6-828A7/envid_t.png">
<meta property="og:updated_time" content="2019-06-29T17:38:27.554Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.828:assignment7:LAB3用户环境">
<meta name="twitter:description" content="Introduction  在Lab2中,mem_init()函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用">
<meta name="twitter:image" content="http://yoursite.com/2019/06/28/mit6-828A7/envid_t.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MIT6.828:assignment7:LAB3用户环境</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2019/06/13/vim常用操作/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Post Anterior</span>
      <span id="i-next" class="info" style="display:none;">Post Següent</span>
      <span id="i-top" class="info" style="display:none;">Adalt</span>
      <span id="i-share" class="info" style="display:none;">Compartir Post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/28/mit6-828A7/&text=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/28/mit6-828A7/&is_video=false&description=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MIT6.828:assignment7:LAB3用户环境&body=Check out this article: http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/28/mit6-828A7/&name=MIT6.828:assignment7:LAB3用户环境&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-A：用户环境和异常处理"><span class="toc-number">2.</span> <span class="toc-text">Part A：用户环境和异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Environment-State"><span class="toc-number">2.1.</span> <span class="toc-text">Environment State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Allocating-the-Environments-Array"><span class="toc-number">2.2.</span> <span class="toc-text">Allocating the Environments Array</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise1"><span class="toc-number">2.3.</span> <span class="toc-text">Exercise1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-and-Running-Environments"><span class="toc-number">2.4.</span> <span class="toc-text">Creating and Running Environments</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise2"><span class="toc-number">2.5.</span> <span class="toc-text">Exercise2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-Interrupts-and-Exceptions"><span class="toc-number">2.6.</span> <span class="toc-text">Handling Interrupts and Exceptions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise3"><span class="toc-number">2.7.</span> <span class="toc-text">Exercise3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Basics-of-Protected-Control-Transfer"><span class="toc-number">2.8.</span> <span class="toc-text">Basics of Protected Control Transfer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Types-of-Exceptions-and-Interrupts"><span class="toc-number">2.9.</span> <span class="toc-text">Types of Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#An-Example"><span class="toc-number">2.10.</span> <span class="toc-text">An Example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nested-Exceptions-and-Interrupts"><span class="toc-number">2.11.</span> <span class="toc-text">Nested Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-Up-the-IDT"><span class="toc-number">2.12.</span> <span class="toc-text">Setting Up the IDT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise4"><span class="toc-number">2.13.</span> <span class="toc-text">Exercise4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge"><span class="toc-number">2.14.</span> <span class="toc-text">challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Questions"><span class="toc-number">2.15.</span> <span class="toc-text">Questions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-B：Page-Fault（缺页），断点异常，系统调用"><span class="toc-number">3.</span> <span class="toc-text">Part B：Page Fault（缺页），断点异常，系统调用</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MIT6.828:assignment7:LAB3用户环境
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">JiHandong's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-06-27T21:00:40.000Z" itemprop="datePublished">2019-06-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/MIT6-828/">MIT6.828</a>, <a class="tag-link" href="/tags/OS/">OS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>  在Lab2中,<code>mem_init()</code>函数设置了JOS内核的二级页表，但是对用户环境没有做处理，本次实验需要使用数据结构保护追踪用户环境，创建用户环境、加载program image，并执行。还要使JOS能够处理任何用户环境下的系统调用和异常。<br>  PS：本次实验“环境（environment）”和“进程（process）”是等价的，两者都表示程序在运行时的抽象；本实验中使用术语“环境”只是为了和UNIX的“进程”区分。<br>  创建lab3分支，从lab2中merge过来，本次实验分AB两个部分，schedule上每个部分给予一周时间，同样需要完成所有的练习和至少一个challenge。可以使用<strong>内联汇编</strong>的语法。</p>
<h2 id="Part-A：用户环境和异常处理"><a href="#Part-A：用户环境和异常处理" class="headerlink" title="Part A：用户环境和异常处理"></a>Part A：用户环境和异常处理</h2><p>  阅读<code>inc/env.h</code>文件。<br>  其中数据结构envid_t可以表示一个环境，如图所示，后10位储存在<code>Env</code>中的index，即自己的座位号；而中间的21位是每个环境独一无二的ID；由于envid_t本质上是int，首位为0表示一个正数，如果为1表示为一个负数，对于envid_t负数被解读为错误。<br><img src="/2019/06/28/mit6-828A7/envid_t.png"></p>
<h3 id="Environment-State"><a href="#Environment-State" class="headerlink" title="Environment State"></a>Environment State</h3><p>  阅读<code>inc/env.h</code>文件中定义的<code>struct Env</code>。每个成员都包含了一个环境的关键属性，比如page directory的地址、此环境的id（envid_t类型变量）、父环境的id（envid_t类型变量）。</p>
<h3 id="Allocating-the-Environments-Array"><a href="#Allocating-the-Environments-Array" class="headerlink" title="Allocating the Environments Array"></a>Allocating the Environments Array</h3><p>  Lab2中我们部署了pages线性表，这次来部署一下envs线性表。</p>
<h3 id="Exercise1"><a href="#Exercise1" class="headerlink" title="Exercise1"></a>Exercise1</h3><p><strong>Modify mem_init() in kern/pmap.c to allocate and map the envs array. This array consists of exactly NENV instances of the Env structure allocated much like how you allocated the pages array. Also like the pages array, the memory backing envs should also be mapped user read-only at UENVS (defined in inc/memlayout.h) so user processes can read from this array. You should run your code and make sure check_kern_pgdir() succeeds. </strong><br>  <code>kern/pmap.c</code>中新include了<code>kern/env.h</code>，由<code>inc/env.h</code>的定义，我们知道10位用于在envs中的寻址，所以envs的长度为2^10；<code>envs</code>定义在<code>kern/env.c</code>中。<br>  这部分代码和Lab2中的对pages的分配大同小异，先使用<code>boot_alloc()</code>为envs准备空白的物理地址；随后建立二级页表对UENVS开始的一个PTSIZE进行map。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	envs = (struct Env*) boot_alloc(NENV * <span class="keyword">sizeof</span>(struct Env));</span><br><span class="line">	<span class="built_in">memset</span>(pages, <span class="number">0</span>, NENV * <span class="keyword">sizeof</span>(struct Env));</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="comment">// Map the 'envs' array read-only by the user at linear address UENVS</span></span><br><span class="line">	<span class="comment">// (ie. perm = PTE_U | PTE_P).</span></span><br><span class="line">	<span class="comment">// Permissions:</span></span><br><span class="line">	<span class="comment">//    - the new image at UENVS  -- kernel R, user R</span></span><br><span class="line">	<span class="comment">//    - envs itself -- kernel RW, user NONE</span></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	ptp = page_alloc(<span class="number">1</span>);</span><br><span class="line">	pt = KADDR(PTE_ADDR(page2pa(ptp)));</span><br><span class="line">	kern_pgdir[PDX(UENVS)]= page2pa(ptp) | PTE_U | PTE_P;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> bias = <span class="number">0</span>; bias &lt; NENV*<span class="keyword">sizeof</span>(struct Env); bias += PGSIZE) &#123;</span><br><span class="line">		pt[PTX(UENVS+bias)] = PADDR((<span class="keyword">void</span>*)envs+bias) | PTE_U | PTE_P;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Creating-and-Running-Environments"><a href="#Creating-and-Running-Environments" class="headerlink" title="Creating and Running Environments"></a>Creating and Running Environments</h3><p>  现在我们开始对<code>kern/env.c</code>编程，即我们开始编写运行用户环境的代码。<br>  <code>obj/Makefrag</code>中有一些能够将二进制文件像.o文件那样”link”起来的骚操作；obj/kern/kernel.sym中也能看到一些神奇的符号。<br>  <code>kern/init.c</code>中的<code>i386_init()</code>能够运行上面谈到的二进制image，然而我们还需要在Exercise2中编写设置用户环境的函数。</p>
<h3 id="Exercise2"><a href="#Exercise2" class="headerlink" title="Exercise2"></a>Exercise2</h3><p><strong>In the file env.c, finish coding the following functions:env_init()、env_setup_vm()、region_alloc()、load_icode()、env_create()、env_run()</strong><br>  首先了解一下各个函数的功能：<br>  <code>env_init()</code>初始化envs线性表中的全部Env结构，并全部加入env_free_list；<code>env_init_percpu()</code>能够为不同特权级别的段单独配置segmentation hardware；<br>  <code>env_setup_vm()</code>为新的环境分配page directory，并初始化其中的内核空间（不用用户环境的内核代码都映射且仅映射到同一个地方）；<br>  <code>region_alloc()</code>为新环境allocate长度为len的物理内存并map到环境的地址空间va位置，不需要初始化其中的内容；<br>  <code>load_icode()</code>解析ELF二进制image，加载到用户地址；<br>  <code>env_create()</code>创建新环境需要调用<code>env_alloc()</code>分配空间，调用<code>load_icode()</code>加载；<br>  <code>env_run()</code>以用户模式运行一个给出的环境；<br>  然后我们可以编写代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">env_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span>(struct Env* e = envs+NENV<span class="number">-1</span>; e &gt;= envs; e--) &#123;</span><br><span class="line">		e-&gt;env_id = <span class="number">0</span>;</span><br><span class="line">		e-&gt;env_link = env_free_list;</span><br><span class="line">		env_free_list = e;	</span><br><span class="line">	&#125;</span><br><span class="line">	env_init_percpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化用户环境</span></span><br><span class="line"><span class="comment">// 需要复制kern_pgdir中内核部分的内容</span></span><br><span class="line"><span class="comment">// 其实直接全部复制就可以了，kern_pgdir的内容全是内存映射</span></span><br><span class="line"><span class="comment">// 只有UVPT需要单独设置</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">env_setup_vm(struct Env *e)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line">	p-&gt;pp_ref++;	</span><br><span class="line">	e-&gt;env_pgdir = (<span class="keyword">pde_t</span>*)KADDR(page2pa(p));</span><br><span class="line">	<span class="built_in">memcpy</span>(e-&gt;env_pgdir, kern_pgdir, PGSIZE);</span><br><span class="line">	e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为环境e分配len字节到虚拟地址va</span></span><br><span class="line"><span class="comment">// 使用page_insert更方便</span></span><br><span class="line"><span class="comment">// 有必要熟悉自己在前面实验中完成的函数工具，抽象分层已经做了，不用是自己吃亏</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">region_alloc(struct Env *e, <span class="keyword">void</span> *va, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span>* begin = ROUNDDOWN(va, PGSIZE);</span><br><span class="line">	<span class="keyword">void</span>* end = ROUNDUP(va+len, PGSIZE);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">for</span>(; begin &lt; end; begin += PGSIZE) &#123;</span><br><span class="line">		<span class="keyword">if</span>(!(p = page_alloc(<span class="number">0</span>))) panic(<span class="string">"alloc page failed in region_alloc()\n"</span>);</span><br><span class="line">		page_insert(e-&gt;env_pgdir, p, begin, PTE_W | PTE_U);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">load_icode(struct Env *e, <span class="keyword">uint8_t</span> *binary)</span><br><span class="line">&#123;</span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> *<span class="title">elfhdr</span> = (<span class="title">struct</span> <span class="title">Elf</span>*)<span class="title">binary</span>;</span></span><br><span class="line">	ph = (struct Proghdr *) (binary + elfhdr-&gt;e_phoff);</span><br><span class="line">	eph = ph + elfhdr-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span> (; ph &lt; eph; ph++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(ph-&gt;p_type == ELF_PROG_LOAD) &#123;</span><br><span class="line">			region_alloc(e, (<span class="keyword">void</span>*)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memset</span>((<span class="keyword">void</span>*)ph-&gt;p_va, <span class="number">0</span>, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memcpy</span>((<span class="keyword">void</span>*)ph-&gt;p_va, binary+ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	lcr3(PADDR(kern_pgdir));</span><br><span class="line">	e-&gt;env_tf.tf_eip = elfhdr-&gt;e_entry;</span><br><span class="line"></span><br><span class="line">	region_alloc(e, (<span class="keyword">void</span>*)USTACKTOP - PGSIZE, PGSIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">env_create(<span class="keyword">uint8_t</span> *binary, <span class="keyword">enum</span> EnvType type)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span>* <span class="title">e</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	env_alloc(&amp;e, <span class="number">0</span>);</span><br><span class="line">	load_icode(e, binary);</span><br><span class="line">	e-&gt;env_type = type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">env_run(struct Env *e)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(curenv &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)</span><br><span class="line">		curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line">	curenv = e;</span><br><span class="line">	e-&gt;env_status = ENV_RUNNING;</span><br><span class="line">	e-&gt;env_runs++;</span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">	env_pop_tf(&amp;(e-&gt;env_tf));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Handling-Interrupts-and-Exceptions"><a href="#Handling-Interrupts-and-Exceptions" class="headerlink" title="Handling Interrupts and Exceptions"></a>Handling Interrupts and Exceptions</h3><h3 id="Exercise3"><a href="#Exercise3" class="headerlink" title="Exercise3"></a>Exercise3</h3><h3 id="Basics-of-Protected-Control-Transfer"><a href="#Basics-of-Protected-Control-Transfer" class="headerlink" title="Basics of Protected Control Transfer"></a>Basics of Protected Control Transfer</h3><h3 id="Types-of-Exceptions-and-Interrupts"><a href="#Types-of-Exceptions-and-Interrupts" class="headerlink" title="Types of Exceptions and Interrupts"></a>Types of Exceptions and Interrupts</h3><h3 id="An-Example"><a href="#An-Example" class="headerlink" title="An Example"></a>An Example</h3><h3 id="Nested-Exceptions-and-Interrupts"><a href="#Nested-Exceptions-and-Interrupts" class="headerlink" title="Nested Exceptions and Interrupts"></a>Nested Exceptions and Interrupts</h3><h3 id="Setting-Up-the-IDT"><a href="#Setting-Up-the-IDT" class="headerlink" title="Setting Up the IDT"></a>Setting Up the IDT</h3><h3 id="Exercise4"><a href="#Exercise4" class="headerlink" title="Exercise4"></a>Exercise4</h3><h3 id="challenge"><a href="#challenge" class="headerlink" title="challenge"></a>challenge</h3><h3 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h3><h2 id="Part-B：Page-Fault（缺页），断点异常，系统调用"><a href="#Part-B：Page-Fault（缺页），断点异常，系统调用" class="headerlink" title="Part B：Page Fault（缺页），断点异常，系统调用"></a>Part B：Page Fault（缺页），断点异常，系统调用</h2>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-A：用户环境和异常处理"><span class="toc-number">2.</span> <span class="toc-text">Part A：用户环境和异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Environment-State"><span class="toc-number">2.1.</span> <span class="toc-text">Environment State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Allocating-the-Environments-Array"><span class="toc-number">2.2.</span> <span class="toc-text">Allocating the Environments Array</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise1"><span class="toc-number">2.3.</span> <span class="toc-text">Exercise1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-and-Running-Environments"><span class="toc-number">2.4.</span> <span class="toc-text">Creating and Running Environments</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise2"><span class="toc-number">2.5.</span> <span class="toc-text">Exercise2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-Interrupts-and-Exceptions"><span class="toc-number">2.6.</span> <span class="toc-text">Handling Interrupts and Exceptions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise3"><span class="toc-number">2.7.</span> <span class="toc-text">Exercise3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Basics-of-Protected-Control-Transfer"><span class="toc-number">2.8.</span> <span class="toc-text">Basics of Protected Control Transfer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Types-of-Exceptions-and-Interrupts"><span class="toc-number">2.9.</span> <span class="toc-text">Types of Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#An-Example"><span class="toc-number">2.10.</span> <span class="toc-text">An Example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nested-Exceptions-and-Interrupts"><span class="toc-number">2.11.</span> <span class="toc-text">Nested Exceptions and Interrupts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-Up-the-IDT"><span class="toc-number">2.12.</span> <span class="toc-text">Setting Up the IDT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exercise4"><span class="toc-number">2.13.</span> <span class="toc-text">Exercise4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge"><span class="toc-number">2.14.</span> <span class="toc-text">challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Questions"><span class="toc-number">2.15.</span> <span class="toc-text">Questions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-B：Page-Fault（缺页），断点异常，系统调用"><span class="toc-number">3.</span> <span class="toc-text">Part B：Page Fault（缺页），断点异常，系统调用</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/28/mit6-828A7/&text=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/28/mit6-828A7/&is_video=false&description=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MIT6.828:assignment7:LAB3用户环境&body=Check out this article: http://yoursite.com/2019/06/28/mit6-828A7/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/28/mit6-828A7/&title=MIT6.828:assignment7:LAB3用户环境"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/28/mit6-828A7/&name=MIT6.828:assignment7:LAB3用户环境&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menú</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Compartir</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Cap amunt</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 jihandong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Inici</a></li>
         
          <li><a href="/about/">Qui som</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/projects_url">Projectes</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
